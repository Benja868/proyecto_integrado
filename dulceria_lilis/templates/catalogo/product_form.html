{% extends 'base_admin.html' %}
{% load static %}

{% block title %}{{ page_title }} - Dulcería Lilis{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">{{ page_title }}</h2>

    <form method="POST" class="card p-4 mt-4 shadow-sm" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <!-- Pestañas -->
        <ul class="nav nav-tabs" id="productTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="identificacion-tab" data-bs-toggle="tab" data-bs-target="#identificacion" type="button" role="tab">1. Identificación y Precios</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stock-control-tab" data-bs-toggle="tab" data-bs-target="#stock-control" type="button" role="tab">2. Stock y Control</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="relaciones-tab" data-bs-toggle="tab" data-bs-target="#relaciones" type="button" role="tab">3. Relaciones y Derivados</button>
            </li>
        </ul>

        <!-- Contenido de Pestañas -->
        <div class="tab-content pt-4">

            <!-- Pestaña 1: Identificación y Precios -->
            <div class="tab-pane fade show active" id="identificacion" role="tabpanel">
                <h5>Identificación</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">{{ form.sku.label_tag }} {{ form.sku }} {{ form.sku.errors }}</div>
                    <div class="col-md-4">{{ form.ean_upc.label_tag }} {{ form.ean_upc }} {{ form.ean_upc.errors }}</div>
                    <div class="col-md-4">{{ form.name.label_tag }} {{ form.name }} {{ form.name.errors }}</div>
                    <div class="col-12">{{ form.description.label_tag }} {{ form.description }} {{ form.description.errors }}</div>
                    <div class="col-md-4">{{ form.category.label_tag }} {{ form.category }} {{ form.category.errors }}</div>
                    <div class="col-md-4">{{ form.brand.label_tag }} {{ form.brand }} {{ form.brand.errors }}</div>
                    <div class="col-md-4">{{ form.model_name.label_tag }} {{ form.model_name }} {{ form.model_name.errors }}</div>
                </div>
                <hr>
                <h5>Unidades y Precios</h5>
                <div class="row g-3">
                    <div class="col-md-4">{{ form.uom_purchase.label_tag }} {{ form.uom_purchase }} {{ form.uom_purchase.errors }}</div>
                    <div class="col-md-4">{{ form.uom_sale.label_tag }} {{ form.uom_sale }} {{ form.uom_sale.errors }}</div>
                    <div class="col-md-4">{{ form.conversion_factor.label_tag }} {{ form.conversion_factor }} {{ form.conversion_factor.errors }}</div>
                    <div class="col-md-4">{{ form.standard_cost.label_tag }} {{ form.standard_cost }} {{ form.standard_cost.errors }}</div>
                    <div class="col-md-4">{{ form.sale_price.label_tag }} {{ form.sale_price }} {{ form.sale_price.errors }}</div>
                    <div class="col-md-4">{{ form.tax_rate.label_tag }} {{ form.tax_rate }} {{ form.tax_rate.errors }}</div>
                </div>
            </div>

            <!-- Pestaña 2: Stock y Control -->
            <div class="tab-pane fade" id="stock-control" role="tabpanel">
                <h5>Stock y Control</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">{{ form.stock_min.label_tag }} {{ form.stock_min }} {{ form.stock_min.errors }}</div>
                    <div class="col-md-4">{{ form.stock_max.label_tag }} {{ form.stock_max }} {{ form.stock_max.errors }}</div>
                    <div class="col-md-4">{{ form.reorder_point.label_tag }} {{ form.reorder_point }} {{ form.reorder_point.errors }}</div>
                </div>
                <hr>
                <h5>Control Avanzado</h5>
                <div class="row g-3">
                    <div class="col-md-4 form-check form-switch pt-4"> {{ form.is_perishable }} {{ form.is_perishable.label_tag }} {{ form.is_perishable.errors }}</div>
                    <div class="col-md-4 form-check form-switch pt-4"> {{ form.lot_controlled }} {{ form.lot_controlled.label_tag }} {{ form.lot_controlled.errors }}</div>
                    <div class="col-md-4 form-check form-switch pt-4"> {{ form.serial_controlled }} {{ form.serial_controlled.label_tag }} {{ form.serial_controlled.errors }}</div>
                    <div class="col-md-4 form-check form-switch pt-4"> {{ form.available }} {{ form.available.label_tag }} {{ form.available.errors }}</div>
                </div>
            </div>

            <!-- Pestaña 3: Relaciones y Derivados -->
            <div class="tab-pane fade" id="relaciones" role="tabpanel">
                <h5>Relaciones y Soporte</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">{{ form.image_url.label_tag }} {{ form.image_url }} {{ form.image_url.errors }}</div>
                    <div class="col-md-6">{{ form.datasheet_url.label_tag }} {{ form.datasheet_url }} {{ form.datasheet_url.errors }}</div>
                </div>
                <hr>
                <h5>Derivados (Solo Lectura)</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Stock Actual (Calculado)</label>
                        <input type="text" class="form-control" value="N/A" readonly disabled>
                        <small class="text-muted">Se calcula desde el módulo de Inventario.</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Alerta Bajo Stock</label>
                        <input type="text" class="form-control" value="N/A" readonly disabled>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Alerta por Vencer</label>
                        <input type="text" class="form-control" value="N/A" readonly disabled>
                    </div>
                </div>
            </div>

        </div> <!-- End Tab Content -->

        <!-- Botones -->
        <div class="mt-4">
            <button class="btn btn-primary" type="submit">
                <i class="fas fa-save me-1"></i> Guardar Producto
            </button>
            <a href="{% url 'catalogo:product_list' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Script para activar pestañas Bootstrap (si no funciona automáticamente)
    var triggerTabList = [].slice.call(document.querySelectorAll('#productTab button'))
    triggerTabList.forEach(function (triggerEl) {
    var tabTrigger = new bootstrap.Tab(triggerEl)
    triggerEl.addEventListener('click', function (event) {
        event.preventDefault()
        tabTrigger.show()
    })
    })
</script>
{% endblock %}
